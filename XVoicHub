local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local hrp = character:WaitForChild("HumanoidRootPart")

local defaultWalkSpeed = humanoid.WalkSpeed
local speedEnabled = false
local antiHitEnabled = false
local speedValue = 50

local antiKBConn = nil
local stateConn = nil
local speedConn = nil

local function rebindCharacter(char)
	character = char
	humanoid = character:WaitForChild("Humanoid")
	hrp = character:WaitForChild("HumanoidRootPart")
	defaultWalkSpeed = humanoid.WalkSpeed
	if speedEnabled then
		humanoid.WalkSpeed = speedValue
	end
	if antiHitEnabled then
		humanoid:SetStateEnabled(Enum.HumanoidStateType.Ragdoll, false)
		humanoid:SetStateEnabled(Enum.HumanoidStateType.FallingDown, false)
		humanoid:SetStateEnabled(Enum.HumanoidStateType.PlatformStanding, false)
	end
end

local function stopAntiKB()
	if antiKBConn then antiKBConn:Disconnect() antiKBConn = nil end
	if stateConn then stateConn:Disconnect() stateConn = nil end
end

local function startAntiKB()
	stopAntiKB()
	stateConn = humanoid.StateChanged:Connect(function(_, new)
		if antiHitEnabled then
			if new == Enum.HumanoidStateType.Ragdoll or new == Enum.HumanoidStateType.FallingDown or new == Enum.HumanoidStateType.PlatformStanding then
				task.defer(function()
					if antiHitEnabled and humanoid then
						humanoid.PlatformStand = false
						humanoid:ChangeState(Enum.HumanoidStateType.Running)
					end
				end)
			end
		end
	end)
	antiKBConn = RunService.Heartbeat:Connect(function()
		if antiHitEnabled and hrp and hrp.Parent then
			local v = hrp.AssemblyLinearVelocity
			local w = hrp.AssemblyAngularVelocity
			hrp.AssemblyAngularVelocity = Vector3.new(0, w.Y, 0)
			if humanoid.PlatformStand then humanoid.PlatformStand = false end
			local st = humanoid:GetState()
			if st == Enum.HumanoidStateType.Ragdoll or st == Enum.HumanoidStateType.FallingDown or st == Enum.HumanoidStateType.PlatformStanding or st == Enum.HumanoidStateType.Physics then
				humanoid:ChangeState(Enum.HumanoidStateType.Running)
			end
			local xz = Vector3.new(v.X, 0, v.Z)
			local limit = math.max(humanoid and humanoid.WalkSpeed or 16, speedValue or 16) + 8
			local m = xz.Magnitude
			if m > limit + 2 then
				local clamped = xz.Unit * limit
				hrp.AssemblyLinearVelocity = Vector3.new(clamped.X, v.Y, clamped.Z)
			end
		end
	end)
end

local function applyAntiHit(enable)
	antiHitEnabled = enable
	if enable then
		humanoid:SetStateEnabled(Enum.HumanoidStateType.Ragdoll, false)
		humanoid:SetStateEnabled(Enum.HumanoidStateType.FallingDown, false)
		humanoid:SetStateEnabled(Enum.HumanoidStateType.PlatformStanding, false)
		startAntiKB()
	else
		humanoid:SetStateEnabled(Enum.HumanoidStateType.Ragdoll, true)
		humanoid:SetStateEnabled(Enum.HumanoidStateType.FallingDown
